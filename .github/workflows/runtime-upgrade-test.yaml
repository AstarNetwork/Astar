name: Runtime upgrade test
on:
  issue_comment:
    types: [created, edited]
jobs:
  check-permission:
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/runtime-upgrade-test')
    runs-on: ubuntu-latest
    steps:
    - name: Check permission
      uses: actions/github-script@v6
      with:
        result-encoding: string
        script: |
          const response = await github.rest.repos.getCollaboratorPermissionLevel({
            owner: context.repo.owner,
            repo: context.repo.repo,
            username: context.actor
          });

          const actorPermissionLevel = response.data.permission;
          console.log(actorPermissionLevel);

          // <- lower higher ->
          // ["none", "read", "write", "admin"]
          if (!(actorPermissionLevel == "admin" || actorPermissionLevel == "write")) {
            core.setFailed("Permission denied.");
          }

  runtime-upgrade-test:
    # run only when PR comments start with '/runtime-upgrade-test'.
    if: github.event.issue.pull_request && startsWith(github.event.comment.body, '/runtime-upgrade-test')
    needs: check-permission
    runs-on: ubuntu-latest
    steps:
    - name: Validate and set inputs
      id: test-input
      uses: actions/github-script@v6
      with:
        result-encoding: string
        script: |
          const command = `${{ github.event.comment.body }}`.split(" ");
          console.log(command);

          // command should be '/runtime-upgrade-test runtime'
          if (command.length != 2) {
            core.setFailed("Invalid input. It should be '/runtime-upgrade-test [runtime]'");
          }

          const runtime = command[1];
          if (!['shibuya', 'shiden', 'astar'].includes(runtime)) {
            core.setFailed("Invalid runtime. It should be 'shibuya', 'shiden', or 'astar'.");
          }

          core.setOutput("runtime", runtime);

    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h

    - name: Post starting comment
      uses: actions/github-script@v6
      env:
        MESSAGE: |
          Runtime upgrade test is scheduled at ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}.
          Please wait for a while.
          Runtime: ${{ steps.test-input.outputs.runtime }}
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        result-encoding: string
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: process.env.MESSAGE
          })

    - name: Checkout the source code
      uses: actions/checkout@v3

    - name: Install deps
      run: sudo apt -y install protobuf-compiler

    - name: Install & display rust toolchain
      run: rustup show

    - name: Check targets are installed correctly
      run: rustup target list --installed

    - name: Build runtime
      run: cargo build -p ${{ steps.test-input.outputs.runtime }}-runtime --release --locked

    - name: Run runtime upgrade test
      id: test
      run: |
        cd .github/scripts
        yarn test:runtime-upgrade-${{ steps.test-input.outputs.runtime }}

    - name: Post result comment
      uses: actions/github-script@v6
      env:
        MESSAGE: |
          Runtime upgrade test finished:

          ${{ steps.test.outputs }}
      with:
        github-token: ${{secrets.GITHUB_TOKEN}}
        result-encoding: string
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: process.env.MESSAGE
          })
