name: RPC test

on:
  pull_request:
    branches:
      - master

  push:
    branches:
      - master

jobs:
  build:
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: [self-hosted, Linux, X64]
    steps:
    - name: Checkout the source code
      uses: actions/checkout@master
      with:
        submodules: true

    - name: Install & display rust toolchain
      run: rustup show

    - name: Check targets are installed correctly
      run: rustup target list --installed

    - uses: actions/cache@v2
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          ${{ runner.os }}-cargo

    - name: Build optimized binary
      run: CARGO_PROFILE_RELEASE_LTO=true RUSTFLAGS="-C codegen-units=1" cargo build --release --verbose

    - uses: actions/upload-artifact@master
      with:
        name: astar-ubuntu-latest-x86_64
        path: target/release/astar-collator

  test:
    runs-on: ubuntu-latest
    needs: build
    strategy:
      matrix:
        node-version: [16.x]
    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v2
      with:
        node-version: ${{ matrix.node-version }}
    - run: yarn install
      working-directory: ./rpc-tests
    - run: yarn test
      working-directory: ./rpc-tests