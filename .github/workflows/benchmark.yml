name: Benchmarks
on: workflow_dispatch
inputs:
  pallets:
    description: 'Pallets to benchmark. Select "all" to execute all pallets, Use "," to choose multiple pallets to execute (e.g. pallet_balances,pallet_dapps_staking).'
    required: true
jobs:
  benchmarks:
    runs-on: ubuntu-latest # For now. Use dedicated benchmark machine once it is ready.
    steps:
    - name: Free disk space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h

    - name: Checkout the source code
      uses: actions/checkout@v3
      with:
        submodules: true

    - name: Install deps
      run: sudo apt -y install protobuf-compiler

    - name: Install & display rust toolchain
      run: rustup show

    - name: Check targets are installed correctly
      run: rustup target list --installed

    - name: Execute benchmarking
      run:
        mkdir -p ./benchmark-results
        ./scripts/run_benchmark -o ./benchmark-results -p ${{ inputs.pallets }}

    - uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: ./benchmark-results
